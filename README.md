# Deploy MongoDB & OpsManager locally with Kubernetes (MCK)

Using MongoDB Controllers for Kubernetes (MCK) to deploy MongoDB and Ops Manager locally.  
This is an opinionated tutorial aiming to simplify the deployment process.  
Feel free to clone this repo and to apply changes as you prefer.  

## Prerequisities

- [Make](https://www.gnu.org/software/make/) for running the make files.
- [MongoDB Shell](https://www.mongodb.com/docs/mongodb-shell/) installed on your local machine.
- [MongoDB Compass](https://www.mongodb.com/products/tools/compass) to connect to the MongoDB Server.
- [Docker](https://www.docker.com/) to manage your containers.
- [Kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl-macos/) to run commands against Kubernetes clusters.
- [K3d](https://k3d.io/stable/) to create local Kubernetes clusters.
- [K9s](https://k9scli.io/) to manage your local clusters (optional but recommended).

### Recommendations
- Docker resource allocation to avoid issues: `Docker -> Settings -> Resources`.  
- Memory limit: 20GB
- CPU limit: 10

## Setup a local K3d cluster

To spin-up the local K3d cluster, run the following command 

```
k3d cluster create mongodb-mck-cluster
```
This will create a ``mongodb-mck-cluster`` local cluster and it will set the context to it.  
Verify the new cluster by running ``kubectl get nodes`` command or with `k9s`.  


## Install the operator

To install the MongoDB Controllers for Kubernetes (enterprise) run the makefile on the ``./operator`` folder:

```
make install-mck
```

This will install the latest version of the MCK operator via Helm.  
To verify the installation you can run ``k9s -n mongodb-operator``

## Deploy Ops Manager

Fill your credentials in the ``ops-manager/secret.yaml`` file.  
Put the desired version of Ops Manager and Application Database (AppDB) in the ``ops-manager/deploy.yaml`` 

Then run the following command from the ``./ops-manager`` folder:

```
make deploy-om
```  

The deployment may take long (10 minutes or more) since the operator will pull the images of ``AppDB`` and ``OpsManager`` (2GB). Also, OpsManager needs around 5 minutes to start.  

You can verify the on-going deployment by running ``k9s -n mongodb-operator``.  
You will see the pods starting:
- three replicas of AppDB (ops-manager-db) 
- one instance of OpsManager (ops-manager)

### Verification

After around 15 minutes, if you run ``k9s -n mongodb-operator`` you must see:

![Alt text](/images/k9s-after-install.png)

## Accessing OpsManager via browser

If you check all the Kubernetes services, by running ``kubectl get svc -n mongodb-operator`` you will find out that there is a LoadBalancer ``ops-manager-svc-ext`` with EXTERNAL-IP ``<pending>``. This LoadBalancer would provide external access to OpsManager, and we would be able to access it via browser. For simplicitly, we will use port forward to do so. OpsManager is available via ``ops-manager-db-svc`` service via port ``8080`` thus we will forward this. 

Run the following command, and leave it running:

```
kubectl port-forward service/ops-manager-svc 8080:8080 -n mongodb-operator
```  

Now you can access OpsManager, deployed locally with Kubernetes, via browser:

```
http://localhost:8080
```

You will see the login page of OpsManager running in your local Kubernetes cluster.

![Alt text](/images/om-login.png)

### Create a new user

If this is your first access with OpsManager, create a new user by clicking in Sign-up.  
Fill all the fields, and you will be redirected to the control panel web-app.


## Configuring Ops Manager and MCK

First step is to generate the ``API Key`` through Ops Manager.  
To do so, go to:  
```
Organization > Access Managaer > Create API Key (as an Org Owner)
```

While creating the API Key, we need to add the IP address of the Operator to the API access list.  
For this, find the Operator IP:
```
kubectl get pod -n mongodb-operator -o wide | grep mongodb-kubernetes-operator
```

Copy the IP address and add to the API Key ``API Access List``   

### Generate YAML files
The ``replica-set/secret.yaml`` and ``replica-set/config-map.yaml`` files needs to be generated by using the Kubernetes Setup on the organization settings. Remember to update the namespace to ``mongodb-operator``.

## Other operations - WiP

- [Deploy replica-set](https://github.com/vinilage/mck-om/blob/main/replica-set/README.md)
- Deploy sharded cluster
- Deploy multi-cluster
- Configure TLS

## Generate ARM compatible image of Ops Manager - WiP

Work in progress...

OpsManager is a Java application, which means that it is portable to different architectures by using the proper JDK.  
At the time of writing this doc, OpsManager has no official support for ARM architecture, which means that you cannot find an official arm package in the [download center](https://www.mongodb.com/try/download/ops-manager) as well as you will not find an official arm image in our [Quay](https://quay.io/repository/mongodb/mongodb-enterprise-ops-manager-ubi?tab=tags&tag=latest) registries. Because of this, the arm image of OpsManager will be built locally, and we will need to configure the Kubernetes Operator to use this local image. This is possible, since the operator offers support of [static-architecture](https://www.mongodb.com/docs/kubernetes/current/tutorial/plan-k8s-op-container-images/).

### Building ARM OM image locally

For building Ops Manager 8.0.7 Docker image locally use the following command.  
If you need to change the version, you will need to update the download [links](https://github.com/karl-denby/mongo-infra-docker/blob/main/ops-manager/quick-start.sh) as well.

```bash
VERSION="8.0.7"
OM_DOWNLOAD_URL="https://downloads.mongodb.com/on-prem-mms/tar/mongodb-mms-8.0.7.500.20250505T1426Z.tar.gz"
JDK_ARM_DOWNLOAD_URL="https://github.com/adoptium/temurin21-binaries/releases/download/jdk-21.0.6%2B7/OpenJDK21U-jdk_aarch64_linux_hotspot_21.0.6_7.tar.gz" 
docker buildx build --load --progress plain . \
  -f docker/mongodb-enterprise-ops-manager/Dockerfile \
  -t "mongodb-enterprise-ops-manager:${VERSION}" \
  --build-arg version="${VERSION}" \
  --build-arg om_download_url="${OM_DOWNLOAD_URL}" \
  --build-arg jdk_arm_download_url="${JDK_ARM_DOWNLOAD_URL}"
```


## References

- Github repo: [ent-mongodb-operator](https://github.com/kamloiic/ent-mongodb-opertor)
- [MonoDB Controllers for Kubernetes](https://www.mongodb.com/docs/kubernetes-operator/current/)

