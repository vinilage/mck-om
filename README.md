# Deploy OpsManager and MongoDB locally with Kubernetes (MCK)

Using MongoDB Controllers for Kubernetes (MCK) to deploy MongoDB and Ops Manager locally.  
This is an opinionated tutorial aiming to simplify the deployment process.  
Feel free to clone this repo and to apply changes as you prefer.  

## Prerequisities

- [Make](https://www.gnu.org/software/make/) for running the make files.
- [MongoDB Shell](https://www.mongodb.com/docs/mongodb-shell/) installed on your local machine.
- [Docker](https://www.docker.com/) to manage your containers.
- [Kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl-macos/) to run commands against Kubernetes clusters.
- [Kind](https://kind.sigs.k8s.io/) to create local Kubernetes clusters.
- [K9s](https://k9scli.io/) to manage your local clusters (optional but recommended).


## Setup a local Kind cluster

To spin-up the local Kind cluster, run the makefile on the `./setup` folder using this command 

```
make create-kind-cluster
```
This will create a ``mongodb-mck-cluster`` local cluster and it will set the context to it.  
Verify the new cluster by running ``kubectl get nodes`` command.  


## Install the operator

To install the MongoDB Controllers for Kubernetes (enterprise) run the makefile on the ``./operator`` folder:

```
make install-mck
```

This will install the latest version of the MCK operator via Helm.  
To verify the installation you can run:
- ``helm list --namespace mongodb-operator`` 
- ``kubectl get pods -n mongodb-operator``
- ``k9s -n mongodb-operator``

## Deploy Ops Manager

Fill your credentials in the ``ops-manager/secret.yaml`` file.  
Put the desired version of Ops Manager and Application Database (AppDB) in the ``ops-manager/deploy.yaml`` 

Then run the following command from the ``./operator`` folder:

```
make deploy-om
```  

The deployment may take long (10 minutes or more) since the operator will pull the images of ``AppDB`` and ``OpsManager`` (2GB).  
Also, OpsManager needs around 5 minutes to start.  

You can verify the on-going deployment by running ``k9s -n mongodb-operator``.  
You will see the pods starting:
- three replicas of AppDB (ops-manager-db) 
- one instance of OpsManager (ops-manager)

### Verification

After 15 minutes, if you run ``k9s -n mongodb-operator`` you must see:

![Alt text](/images/k9s-after-install.png)

## Accessing OpsManager via browser

If you check all the Kubernetes services, by running ``kubectl get svc -n mongodb-operator`` you will find out that there is a LoadBalancer ``ops-manager-svc-ext`` with EXTERNAL-IP ``<pending>``. This LoadBalancer would provide external access to OpsManager, and we would be able to access it via browser. Unfortunately Kind does not support the primitive LoadBalancer, so we will use port forward to do so. OpsManager is available via ``ops-manager-db-svc`` service via port ``8080`` thus we will forward this. 

Run the following command, and leave it running:

```
kubectl port-forward service/ops-manager-svc 8080:8080 -n mongodb-operator
```  

Now you can access OpsManager, deployed locally with Kubernetes, via browser:

```
http://localhost:8080
```

You will see the login page of OpsManager running in your local Kubernetes cluster.

![Alt text](/images/om-login.png)

### Create a new user

If this is your first access with OpsManager, create a new user by clicking in Sign-up.  
Fill all the fields, and you will be redirected to the control panel web-app.


## Deploy a replica set

First step is to generate the ``API Key`` through Ops Manager.  
To do so, go to:  
```
Organization > Access Managaer > Create API Key (as an Org Owner)
```

While creating the API Key, we need to add the IP address of the Operator to the API access list.  
For this, find the Operator IP:
```
kubectl get pod -n mongodb-operator -o wide | grep mongodb-kubernetes-operator
```

Copy the IP address and add to the API Key ``API Access List``   

### Generate YAML files
The ``rep-set/secret.yaml`` and ``rep-set/config-map.yaml`` files needs to be generated by using the Kubernetes Setup on the organization settings. Remember to update the namespace to ``mongodb-operator``.

Run the following command in the ``./rep-set`` folder to start deploying the replica-set under a new project.
```
make deploy-rs
```

### Verification
If everything goes well, in ``Projects > replica-set > Deployment`` and you will see 3 replicas.
It may take some minutes to have them running, since the binaries will be downloaded.

![Alt text](/images/om-replicaset.png)


To troubleshoot evuentual IP issues, run the following command
```
kubectl describe mdb replica-set -n mongodb-operator 
```

### Connect to the replica set (from the pod)

To connect to the replica set from inside the cluster, run the following command
```
kubectl run -i --tty mongo-client --rm \
  --image=mongo \
  --restart=Never \
  -- bash
```

Inside the pod, you will run this following command
```
mongosh --host replica-set-0.replica-set-svc.mongodb-operator.svc.cluster.local --port 27017
```

Note: you can also find a way to connect by using this [link](https://www.mongodb.com/docs/ops-manager/v8.0/tutorial/connect-to-mongodb/)

### Connect to the replica set (using port-forward)

To forward a port from the MongoDB replica set to you local machine, run the following command
```
kubectl port-forward pod/replica-set-0 27017:27017 -n mongodb-operator

```

Once it is set,up, connect to MongoDB using this command 
```
mongosh --host localhost --port 27017
```

Verify the connection using ``rs.status()``


## References

- Github repo: [ent-mongodb-operator](https://github.com/kamloiic/ent-mongodb-opertor)
- [MonoDB Controllers for Kubernetes](https://www.mongodb.com/docs/kubernetes-operator/current/)

## Next steps 

- Enable TLS Certificate
- Support for sharding cluster
- Support for multi-cluster deployments
