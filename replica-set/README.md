# Deploy a replica set

## Prerequisities:  
All the prerequisites steps are [here](https://github.com/vinilage/mck-om).
- Kubernetes cluster
- MCK installed
- OpsManager running 

## Configuring Ops Manager and MCK

First step is to generate the ``API Key`` through Ops Manager.  
To do so, go to:  
```
Organization > Access Managaer > Create API Key (as an Org Owner)
```

While creating the API Key, we need to add the IP address of the Operator to the API access list.  
For this, find the Operator IP:
```
kubectl get pod -n mongodb-operator -o wide | grep mongodb-kubernetes-operator
```

Copy the IP address and add to the API Key ``API Access List``   

### Generate YAML files
The ``replica-set/secret.yaml`` and ``replica-set/config-map.yaml`` files needs to be generated by using the Kubernetes Setup on the organization settings. Remember to update the namespace to ``mongodb-operator``.

## Deploying the replica set

Run the following command in the ``./replica-set`` folder to start deploying the replica-set under a new project.
```
make deploy-rs
```

### Verification
If everything goes well, in OpsManager ``Projects > replica-set > Deployment`` and you will see 3 replicas.
It may take some minutes to have them running, since the binaries will be downloaded.

![Alt text](/images/om-replicaset.png)

In K9s you also should see all the replicaset members up and running:  

![Alt text](/images/replicaset-k9s.png)

To troubleshoot evuentual IP issues, run the following command
```
kubectl describe mdb replica-set -n mongodb-operator 
```

### Connect to the replica set (using port-forward)

To connect to the replica set from outside the Kubernetes cluster, we need to forward the port of the replicaset service:
```
kubectl port-forward -n mongodb-operator svc/replica-set-svc 27017:27017
```

Then you can connect for instance with MongoDB Compass, simply by creating a new connection to localhost.  
At this point, there is no user or password, so the connection string is really only:
```
mongodb://localhost:27017/admin?authSource=admin&directConnection=true
```

You will see something like this:

![Alt text](/images/compass.png)

## Continue
- [Enable SCRUM and create database users](https://github.com/vinilage/mck-om/blob/main/user/README.md)
- [Deploy Search & Vector Search](https://github.com/vinilage/mck-om/blob/main/search/README.md)

## References

- Github repo: [ent-mongodb-operator](https://github.com/kamloiic/ent-mongodb-opertor)
- [MonoDB Controllers for Kubernetes](https://www.mongodb.com/docs/kubernetes-operator/current/)

